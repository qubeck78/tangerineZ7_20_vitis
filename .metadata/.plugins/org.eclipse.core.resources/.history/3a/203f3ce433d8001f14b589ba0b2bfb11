#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>
#include <math.h>
#include "platform.h"

#include "bsp.h"
#include "osAlloc.h"
#include "osFile.h"
#include "gfFont.h"
#include "gfBitmap.h"
#include "gfJPEG.h"
#include "gfDrawing.h"
#include "osUIEvents.h"
#include "mp3dec.h"

//defined in gfxLib/bsp.c
extern tgfTextOverlay  con;

tgfBitmap         screen;

int main()
{
   uint32_t       j;
   tosUIEvent     event;
   uint32_t         i;
   uint32_t         rv;
   uint32_t         nbr;

   MP3FrameInfo     mp3FrameInfo;
   HMP3Decoder      hMP3Decoder;
   char             mp3FileName[256];

   uint32_t         mp3Size;
   int              bytesLeft;
   int16_t         *audioBuffer;
   uint8_t         *mp3Buffer;
   uint8_t         *currentMp3;
   int32_t          offset;
   uint32_t         frameSize;

   init_platform();
   bspInit();

   screen.flags      = 0;
   screen.width      = 320;
   screen.height     = 240;
   screen.rowWidth   = 320;
   screen.buffer     = (void*)0x41000000;   //fixed frame buffer location for now

   setVideoMode( _VIDEOMODE_320_TEXT80_OVER_GFX );

   gfFillRect( &screen, 0, 0, 319, 239, gfColor( 0, 0, 0) );

   printf( "\n" );
   printf( "        |.\\__/.|    (~\\ \n" );
   printf( "        | O O  |     ) ) \n" );
   printf( "      _.|  T   |_   ( (  \n" );
   printf( "   .-- ((---- ((-------------.\n" );
   printf( "   | Zynq MP3Player 20250119 |\n" );
   printf( "   |     tangerine Z7_20     |\n" );
   printf( "   |     SOC:%08x        |\n", (int)bsp->version );
   printf( "   `-------------------------`\n" );
   printf( "\n\n\n");


   osFInit();
   osUIEventsInit();

   audioBuffer = ( int16_t * )osAlloc( 65536, OS_ALLOC_MEMF_CHIP );

   if( !audioBuffer )
   {
     printf( "can't alloc audio buffer - press pause to reboot\n" );

     do{

         waitKey();

     }while( 1 );

   }

   hMP3Decoder = MP3InitDecoder();

   if( !hMP3Decoder )
   {
     printf( "Can't init mp3 decoder - press pause to reboot\n" );

     do{

         waitKey();

     }while( 1 );
   }


   gfAudioInit();



   i = 0;
   j = 1;
   do
   {
      if( !osGetUIEvent( &event ) )
      {
          if( event.type == OS_EVENT_TYPE_KEYBOARD_KEYPRESS )
          {
             //printf( "%02x ", event.arg1 );
             printf( "%c", event.arg1 );
             fflush( stdout );

             if( event.arg1 == 27 )
             {
                j = 0;
             }
          }
      }
   }while( 1 );


}
